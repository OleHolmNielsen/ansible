  - name: Install the autofs package
    yum:
      name: autofs
      state: present

  - name: Start autofs
    service:
      name=autofs
      state=started
      enabled=yes

  - name: Create file auto_home if it does not exist
    # Method: https://stackoverflow.com/questions/28347717/how-to-create-an-empty-file-with-ansible
    copy:
      content: ""
      dest: "{{ auto_home }}"
      force: no
      owner: root
      group: root
      mode: 0644

  - name: Set SELinux context of file auto_home to that of auto_master
    # Use ls -Z auto_master auto_home, check if they match
    # This changes the target file auto_home:
    command: /usr/bin/chcon --reference={{ auto_master|quote }} {{ auto_home|quote }}
    # Ignore the "changed" status
    changed_when: False

  - name: Editing the auto_home file
    blockinfile:
      path: "{{ auto_home }}"
      state: present
      insertafter: EOF
      marker: "# {mark} ANSIBLE MANAGED BLOCK"
      block: |
        camp		-rsize=8192,wsize=8192,tcp,vers=3	servcamd:/u/camp
        niflheim	-rsize=8192,wsize=8192,tcp,vers=3	vid:/u/raid
        niflheim1	-rsize=8192,wsize=8192,tcp,vers=3	vid:/u/raid
        niflheim2	-rsize=8192,wsize=8192,tcp,vers=3	hrid:/u/raid
        niflheim3	-rsize=8192,wsize=8192,tcp,vers=3	ylgr:/u/raid
        fotonik		-rsize=8192,wsize=8192,tcp,vers=3	ylgr:/u/fotonik
        qwise		-rsize=8192,wsize=8192,tcp,vers=3	ylgr:/u/qwise
        topsoe		-rsize=8192,wsize=8192,tcp,vers=3	ylgr:/u/topsoe
        camd2		-rsize=8192,wsize=8192,tcp,vers=3	niflfs1:/u/camd
        modules		-rsize=8192,wsize=8192,ro,tcp,vers=3	niflopt1:/u/modules/broadwell
        energy		-rsize=8192,wsize=8192,tcp,vers=3	niflfs2:/u/energy
        ntch		-rsize=8192,wsize=8192,tcp,vers=3	niflfs2:/u/ntch
        mek2		-rsize=8192,wsize=8192,tcp,vers=3	niflfs2:/u/mek2
        byg		-rsize=8192,wsize=8192,tcp,vers=3	niflfs2:/u/byg
        archive		-rsize=8192,wsize=8192,tcp,vers=3	archive:/u/archive
        nexmap		-rsize=8192,wsize=8192,tcp,vers=3	servcamd:/u/nexmap
        optik		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u/optik
        ppfe		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u/ppfe
        staff		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u/staff
        tap		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u/tap
        fluids		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u1/fluids
        tekhist		-rsize=8192,wsize=8192,tcp,vers=3	serv309:/u2/tekhist
    notify:
     - Restart autofs

  - name: Create file home_autofs if it does not exist
    # Method: https://stackoverflow.com/questions/28347717/how-to-create-an-empty-file-with-ansible
    copy:
      content: ""
      dest: "{{ home_autofs }}"
      force: no
      owner: root
      group: root
      mode: 0644

  - name: Set SELinux context of file home_autofs to that of auto_master
    command: /usr/bin/chcon --reference={{ auto_master|quote }} {{ home_autofs|quote }}
    # Ignore the "changed" status
    changed_when: False

  - name: Editing the home_autofs file
    blockinfile:
      path: "{{ home_autofs }}"
      state: present
      insertafter: EOF
      marker: "# {mark} ANSIBLE MANAGED BLOCK"
      block: |
        /home /etc/auto.home --timeout=60
    notify:
     - Restart autofs

  - name: SELinux - Allow NFS mounted home directories
    seboolean:
      name: use_nfs_home_dirs
      state: yes
      persistent: yes
